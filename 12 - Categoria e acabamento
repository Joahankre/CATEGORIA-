Imports Inventor
Imports System.Windows.Forms
' ============================================================
' iLogic ‚Äì Gerenciamento de BOM em Montagens
' Developed by Kreimeier & Machado
' Objetivo: Selecionar componentes de montagem a partir da BOM
'           e aplicar propriedades de Categoria e Acabamento
' ============================================================

Sub Main()
    ' Verifica se o documento ativo √© uma montagem
    If ThisApplication.ActiveDocumentType <> DocumentTypeEnum.kAssemblyDocumentObject Then
        MessageBox.Show("Abra uma montagem (.iam) antes de rodar esta regra.", 
                        "Gerenciamento de BOM", 
                        MessageBoxButtons.OK, 
                        MessageBoxIcon.Warning)
        Return
    End If

    Dim oAsmDoc As AssemblyDocument = ThisApplication.ActiveDocument

    ' Criar formul√°rio principal
    Dim frmSelecao As New Form With {
        .Text = "Developed by Kreimeier & Machado - Gerenciamento de Modelos ‚Äì Sele√ß√£o",
        .Width = 650,
        .Height = 850,
        .StartPosition = FormStartPosition.CenterScreen
    }

    ' Painel principal
    Dim mainPanel As New Panel With {.Dock = DockStyle.Fill}
    frmSelecao.Controls.Add(mainPanel)

    ' TreeView
    Dim treeModelos As New TreeView With {
        .Dock = DockStyle.Fill,
        .CheckBoxes = True
    }
    mainPanel.Controls.Add(treeModelos)

    ' Painel inferior de bot√µes
    Dim panelBotoes As New FlowLayoutPanel With {
        .Dock = DockStyle.Bottom,
        .Height = 55,
        .FlowDirection = FlowDirection.LeftToRight,
        .Padding = New Padding(15, 10, 15, 10),
        .WrapContents = False
    }
    frmSelecao.Controls.Add(panelBotoes)

    ' Dimens√µes padr√£o dos bot√µes
    Dim larguraBotao As Integer = 160
    Dim alturaBotao As Integer = 35

    ' Bot√£o: Marcar Todos
    Dim btnMarcarTodos As New Button With {
        .Text = "Marcar Todos",
        .Width = larguraBotao,
        .Height = alturaBotao
    }
    panelBotoes.Controls.Add(btnMarcarTodos)
    AddHandler btnMarcarTodos.Click, Sub() AlterarSelecaoTodos(treeModelos.Nodes, True)

    ' Bot√£o: Desmarcar Todos
    Dim btnDesmarcarTodos As New Button With {
        .Text = "Desmarcar Todos",
        .Width = larguraBotao,
        .Height = alturaBotao
    }
    panelBotoes.Controls.Add(btnDesmarcarTodos)
    AddHandler btnDesmarcarTodos.Click, Sub() AlterarSelecaoTodos(treeModelos.Nodes, False)

    ' Bot√£o: Confirmar
    Dim btnConfirmar As New Button With {
        .Text = "Confirmar Sele√ß√£o",
        .Width = larguraBotao,
        .Height = alturaBotao
    }
    panelBotoes.Controls.Add(btnConfirmar)
    AddHandler btnConfirmar.Click, Sub()
                                       frmSelecao.DialogResult = DialogResult.OK
                                       frmSelecao.Close()
                                   End Sub

    ' Preencher TreeView com a BOM
    AtualizarArvoreBOM_Montagem(treeModelos, oAsmDoc)

    ' Exibir formul√°rio
    If frmSelecao.ShowDialog() <> DialogResult.OK Then Return

    ' Obter documentos selecionados
    Dim modelosSelecionados As New List(Of Document)
    ObterDocumentosSelecionados(treeModelos.Nodes, modelosSelecionados)

    If modelosSelecionados.Count = 0 Then
        MessageBox.Show("Nenhum modelo foi selecionado.", 
                        "Gerenciamento de BOM", 
                        MessageBoxButtons.OK, 
                        MessageBoxIcon.Information)
        Return
    End If

    ' Categorias dispon√≠veis
    Dim categoriasDisponiveis As New List(Of String) From {
        "27 - Corte Laser CH",
        "47 - Corte Laser TB",
        "30 - Serra Fita",
        "33 - Usinagem Interna (Torno & Fresa)",
        "28 - Dobra",
        "38 - El√©trica / Automa√ß√£o",
        "29 - Montagem / Solda",
        "32 - Montagem Final",
        "42 - Usinagem Externa ‚Äì Pol√≠meros",
        "43 - Usinagem Externa ‚Äì Alum√≠nio",
        "44 - Usinagem Externa ‚Äì Policarbonato",
        "45 - Usinagem Externa ‚Äì Eletrofus√£o",
        "46 - Usinagem Externa ‚Äì Inox"
    }

    ' Acabamentos dispon√≠veis
    Dim acabamentosDisponiveis As New List(Of String) From {
        "Escovado",
        "Treme-treme",
        "Polido",
        "Usinado",
        "Decapado",
        "Pintado",
        "Natural",
        "Galvanizado a Frio",
        "Natural / Decapado",
        "Natural / Usinado",
        "N/A"
    }

    ' Aplicar propriedades
    For Each oDoc As Document In modelosSelecionados
        Try
            ThisApplication.Documents.Open(oDoc.FullFileName, True).Activate()
        Catch ex As Exception
            MessageBox.Show("Erro ao abrir o modelo: " & oDoc.DisplayName & vbCrLf & ex.Message,
                            "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Continue For
        End Try

        Dim docSummaryProps As PropertySet
        Try
            docSummaryProps = oDoc.PropertySets.Item("Inventor Document Summary Information")
        Catch ex As Exception
            MessageBox.Show("Erro ao acessar propriedades de " & oDoc.DisplayName & vbCrLf & ex.Message,
                            "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Continue For
        End Try

        ' Sele√ß√£o de Categorias
        Dim categoriasSelecionadas = CustomMultiSelectListBox(
            "Nome: " & oDoc.DisplayName,
            categoriasDisponiveis,
            "Selecionar Categorias")
        If categoriasSelecionadas.Count = 0 Then Continue For

        ' Sele√ß√£o de Acabamentos
        Dim acabamentosSelecionados = CustomMultiSelectListBox(
            "Nome: " & oDoc.DisplayName,
            acabamentosDisponiveis,
            "Selecionar Acabamentos")
        If acabamentosSelecionados.Count = 0 Then Continue For

        ' Gravar Categoria
        Try
            Dim categoriaFinal = String.Join("; ", categoriasSelecionadas)
            Dim categoryProp As Inventor.Property
            Try
                categoryProp = docSummaryProps.Item("Category")
            Catch
                categoryProp = docSummaryProps.Add("", "Category")
            End Try
            categoryProp.Value = categoriaFinal
        Catch ex As Exception
            MessageBox.Show("Erro ao salvar Categoria em: " & oDoc.DisplayName & vbCrLf & ex.Message)
        End Try

      ' Gravar Acabamento em "Keywords"
Try
    Dim acabamentoTexto As String = String.Join("; ", acabamentosSelecionados)

    ' Acessa o PropertySet correto: "Inventor Summary Information"
    Dim summaryProps As PropertySet = oDoc.PropertySets.Item("Inventor Summary Information")

    ' Verifica se a propriedade "Keywords" existe
    Dim keywordsProp As Inventor.Property
    Try
        keywordsProp = summaryProps.Item("Keywords")
    Catch
        keywordsProp = summaryProps.Add("", "Keywords")
    End Try

    ' Atribui o valor do acabamento
    keywordsProp.Value = acabamentoTexto

Catch ex As Exception
    MessageBox.Show("Erro ao salvar 'Keywords' em: " & oDoc.DisplayName & vbCrLf & ex.Message,
                    "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error)
End Try


        oDoc.Save()
        oDoc.Close(True)
    Next
End Sub

' ============================================================
' Fun√ß√µes auxiliares
' ============================================================

Sub AtualizarArvoreBOM_Montagem(treeView As TreeView, asmDoc As AssemblyDocument)
    treeView.Nodes.Clear()
    Dim bomRows As BOMRowsEnumerator = GetBOMRowsFromAssembly(asmDoc)

    If bomRows IsNot Nothing Then
        For Each row As BOMRow In bomRows
            AddBOMRowNode(Row, treeView.Nodes)
        Next
        OrdenarTreeNodes(treeView.Nodes)
        treeView.ExpandAll()
    Else
        MessageBox.Show("N√£o foi poss√≠vel obter a BOM da montagem.", 
                        "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error)
    End If
End Sub

Function GetBOMRowsFromAssembly(asmDoc As AssemblyDocument) As BOMRowsEnumerator
    Try
        Dim bom As BOM = asmDoc.ComponentDefinition.BOM
        bom.StructuredViewEnabled = True
        bom.StructuredViewFirstLevelOnly = False

        For Each view As BOMView In bom.BOMViews
            If View.ViewType = BOMViewTypeEnum.kStructuredBOMViewType Then
                Return View.BOMRows
            End If
        Next
    Catch ex As Exception
        MessageBox.Show("Erro ao acessar a BOM: " & ex.Message, "Erro")
    End Try
    Return Nothing
End Function

Sub AddBOMRowNode(row As BOMRow, parent As TreeNodeCollection)
    Static docPathsAdicionados As New HashSet(Of String)

    Try
        If row.ComponentDefinitions IsNot Nothing AndAlso row.ComponentDefinitions.Count > 0 Then
            Dim def = row.ComponentDefinitions.Item(1)
            If TypeOf def Is PartComponentDefinition AndAlso CType(def, PartComponentDefinition).IsContentMember Then Return
            If def.BOMStructure <> BOMStructureEnum.kNormalBOMStructure Then Return
        End If

        Dim docPath As String = ""
        Dim partName As String = ""
        Dim itemName As String = row.ItemNumber

        Try
            If row.ComponentDefinitions IsNot Nothing AndAlso row.ComponentDefinitions.Count > 0 Then
                Dim doc = row.ComponentDefinitions.Item(1).Document
                docPath = doc.FullFileName

                ' Verifica se o caminho j√° foi adicionado
                If docPathsAdicionados.Contains(docPath) Then Return
                docPathsAdicionados.Add(docPath)

                Try
                    partName = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value
                Catch
                End Try
            End If
        Catch
        End Try

        Dim labelNumber As String = If(partName <> "", partName, itemName)

' Tentar extrair a propriedade "Category"
Dim categoriaRaw As String = ""
Dim categoriaCodigo As String = "üîò N/A" ' Valor padr√£o

Try
    Dim doc = row.ComponentDefinitions.Item(1).Document
    categoriaRaw = doc.PropertySets.Item("Inventor Document Summary Information").Item("Category").Value
Catch
    categoriaRaw = ""
End Try

' Aplicar l√≥gica para extrair o c√≥digo da categoria
If InStr(categoriaRaw, " - ") > 0 Then
    Dim parts() As String = Split(categoriaRaw, " - ")
    categoriaCodigo = Trim(parts(0)) ' Pega apenas o n√∫mero/c√≥digo antes do " - "
ElseIf Trim(categoriaRaw) <> "" Then
    categoriaCodigo = Trim(categoriaRaw)
End If

' Texto final do n√≥ com a categoria
Dim nodeText As String = String.Format(" {0} - [ {1} ] - {2}  ", categoriaCodigo, itemName, labelNumber)


        Dim tag = Tuple.Create(docPath, itemName, labelNumber)
        Dim node As New TreeNode(nodeText) With {
            .Tag = tag,
            .Name = itemName
        }
        parent.Add(node)

        If row.ChildRows IsNot Nothing AndAlso row.ChildRows.Count > 0 Then
            For Each child As BOMRow In row.ChildRows
                AddBOMRowNode(child, node.Nodes)
            Next
        End If
    Catch
    End Try
End Sub


Sub OrdenarTreeNodes(nodes As TreeNodeCollection)
    Dim tempList As New List(Of TreeNode)
    For Each node As TreeNode In nodes
        tempList.Add(node)
    Next

    tempList.Sort(Function(a, b) CompararHierarquia(a.Name, b.Name))

    nodes.Clear()
    For Each node As TreeNode In tempList
        nodes.Add(node)
        If node.Nodes.Count > 0 Then
            OrdenarTreeNodes(node.Nodes)
        End If
    Next
End Sub

Function CompararHierarquia(a As String, b As String) As Integer
    Dim numA As Integer = 0
    Dim numB As Integer = 0
    Integer.TryParse(a, numA)
    Integer.TryParse(b, numB)
    Return numA.CompareTo(numB)
End Function

Sub ObterDocumentosSelecionados(nodes As TreeNodeCollection, modelosSelecionados As List(Of Document))
    For Each node As TreeNode In nodes
        If node.Checked And node.Tag IsNot Nothing Then
            Dim tag = CType(node.Tag, Tuple(Of String, String, String))
            Dim docPath As String = tag.Item1
            If Not String.IsNullOrEmpty(docPath) Then
                Try
                    Dim doc As Document = ThisApplication.Documents.Open(docPath, False)
                    modelosSelecionados.Add(doc)
                Catch
                End Try
            End If
        End If
        If node.Nodes.Count > 0 Then
            ObterDocumentosSelecionados(node.Nodes, modelosSelecionados)
        End If
    Next
End Sub

Sub AlterarSelecaoTodos(nodes As TreeNodeCollection, selecionado As Boolean)
    For Each node As TreeNode In nodes
        node.Checked = selecionado
        If node.Nodes.Count > 0 Then
            AlterarSelecaoTodos(node.Nodes, selecionado)
        End If
    Next
End Sub

Function CustomMultiSelectListBox(prompt As String, options As List(Of String), title As String) As List(Of String)
    Dim selected As New List(Of String)

    Dim frm As New Form With {
        .Text = title,
        .Width = 420,
        .Height = 520,
        .StartPosition = FormStartPosition.Manual
    }

    frm.Left = 1500
    frm.Top = 200

    Dim layout As New TableLayoutPanel With {
        .Dock = DockStyle.Fill,
        .RowCount = 4,
        .ColumnCount = 1
    }

    layout.RowStyles.Add(New RowStyle(SizeType.Absolute, 50)) ' Label
    layout.RowStyles.Add(New RowStyle(SizeType.Percent, 100)) ' Lista
    layout.RowStyles.Add(New RowStyle(SizeType.Absolute, 45)) ' Bot√£o girar
    layout.RowStyles.Add(New RowStyle(SizeType.Absolute, 45)) ' Bot√£o confirmar

    ' Label
    Dim lbl As New Label With {
        .Text = prompt,
        .Dock = DockStyle.Fill,
        .Padding = New Padding(10)
    }
    layout.Controls.Add(lbl, 0, 0)

    ' CheckedListBox
    Dim clb As New CheckedListBox With {
        .Dock = DockStyle.Fill,
        .CheckOnClick = True
    }
    For Each opt In options
        clb.Items.Add(opt, False)
    Next
    layout.Controls.Add(clb, 0, 1)

    ' Bot√£o: Girar 360¬∞
    Dim btnGirar As New Button With {
        .Text = "Rotacionar Montagem",
        .Dock = DockStyle.Fill
    }
    layout.Controls.Add(btnGirar, 0, 2)
    AddHandler btnGirar.Click, Sub()
                                    RotacionarMontagem360()
                                End Sub

    ' Bot√£o: Confirmar
    Dim btnOk As New Button With {
        .Text = "Confirmar",
        .Dock = DockStyle.Fill
    }
    layout.Controls.Add(btnOk, 0, 3)

    frm.AcceptButton = btnOk

    AddHandler btnOk.Click, Sub()
                                frm.DialogResult = DialogResult.OK
                                frm.Close()
                            End Sub

    frm.Controls.Add(layout)

    If frm.ShowDialog() = DialogResult.OK Then
        For Each idx As Integer In clb.CheckedIndices
            selected.Add(clb.Items(idx).ToString())
        Next
    End If

    Return selected
End Function
Sub RotacionarMontagem360()
    Try
        Dim oDoc As Document = ThisApplication.ActiveDocument
        Dim oView As Inventor.View = ThisApplication.ActiveView
        Dim oCamera As Camera = oView.Camera

        ' Captura o ponto de foco atual (centro do modelo)
        Dim oTarget As Point = oCamera.Target

        ' Define a dist√¢ncia da c√¢mera ao modelo (raio da √≥rbita)
        Dim distancia As Double = oCamera.Eye.DistanceTo(oTarget)

        ' Define vetor "para cima"
        Dim upVec As Double() = {0, 0, 1} ' Z para cima

        ' Gira de 0 a 360 graus em etapas
        For anguloGraus As Integer = 0 To 359 Step 70
            Dim anguloRad As Double = anguloGraus * Math.PI / 180.0

            ' C√°lculo da posi√ß√£o da c√¢mera ao redor do modelo
            Dim x As Double = oTarget.X + distancia * Math.Cos(anguloRad)
            Dim y As Double = oTarget.Y + distancia * Math.Sin(anguloRad)
            Dim z As Double = oCamera.Eye.Z ' Mant√©m a altura constante

            ' Aplica nova posi√ß√£o da c√¢mera
            InventorVb.SetViewCamera(
                ViewCameraOption.FitExtents,
                New Double() {x, y, z},
                New Double() {oTarget.X, oTarget.Y, oTarget.Z},
                upVec,
                New Double() {0, 0, 0}
            )

            ' Atualiza a interface para permitir anima√ß√£o visual
            ThisApplication.UserInterfaceManager.DoEvents()
        Next

                ' === Definir a c√¢mera manualmente para vista isom√©trica ===
        Dim Camera As Camera = ThisApplication.ActiveView.Camera

        Camera.ViewOrientationType = ViewOrientationTypeEnum.kIsoTopRightViewOrientation
        Camera.Fit()
        Camera.Apply()


    Catch ex As Exception
        MessageBox.Show("Erro ao girar o modelo com SetViewCamera: " & ex.Message,
                        "Erro de Visualiza√ß√£o",
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Error)
    End Try
End Sub


