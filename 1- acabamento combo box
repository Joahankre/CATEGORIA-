' === Verifica se é uma montagem ===
If ThisApplication.ActiveDocumentType <> DocumentTypeEnum.kAssemblyDocumentObject Then
    MessageBox.Show("Abra uma montagem (.iam) antes de executar esta regra.", "Erro")
    Return
End If

Dim oAsmDoc As AssemblyDocument = ThisApplication.ActiveDocument
Dim oCompOccs As ComponentOccurrences = oAsmDoc.ComponentDefinition.Occurrences

' === Coleta documentos únicos ===
Dim compDocs As New Dictionary(Of String, Document)
For Each occ As ComponentOccurrence In oCompOccs.AllLeafOccurrences
    Try
        Dim path As String = occ.Definition.Document.FullFileName
        If Not compDocs.ContainsKey(path) Then
            compDocs.Add(path, occ.Definition.Document)
        End If
    Catch
        ' Ignora componentes não resolvidos
    End Try
Next

' === Formulário de seleção ===
Dim frmSelecao As New System.Windows.Forms.Form With {
    .Text = "Selecione os modelos para editar",
    .Width = 600,
    .Height = 550,
    .StartPosition = FormStartPosition.CenterScreen
}

frmSelecao.Controls.Add(New System.Windows.Forms.Label With {
    .Text = "Digite o prefixo e clique em 'Filtrar':",
    .Top = 10,
    .Left = 10,
    .Width = 560
})

Dim txtPrefixo As New System.Windows.Forms.TextBox With {.Top = 35, .Left = 10, .Width = 400}
frmSelecao.Controls.Add(txtPrefixo)

Dim btnFiltrar As New System.Windows.Forms.Button With {.Text = "Filtrar", .Top = 33, .Left = 420, .Width = 150}
frmSelecao.Controls.Add(btnFiltrar)

Dim lstModelos As New System.Windows.Forms.CheckedListBox With {
    .Top = 70, .Left = 10, .Width = 560, .Height = 320,
    .CheckOnClick = True, .Anchor = AnchorStyles.Top Or AnchorStyles.Bottom Or AnchorStyles.Left Or AnchorStyles.Right
}
frmSelecao.Controls.Add(lstModelos)

Dim btnSelecionarTodos As New System.Windows.Forms.Button With {.Text = "Selecionar Todos", .Top = 400, .Left = 10, .Width = 180}
Dim btnDesmarcarTodos As New System.Windows.Forms.Button With {.Text = "Desmarcar Todos", .Top = 400, .Left = 200, .Width = 180}
Dim btnOk As New System.Windows.Forms.Button With {.Text = "Confirmar", .Top = 440, .Left = 10, .Width = 560, .Height = 30}

frmSelecao.Controls.Add(btnSelecionarTodos)
frmSelecao.Controls.Add(btnDesmarcarTodos)
frmSelecao.Controls.Add(btnOk)

' === Atualiza lista com filtro ===
Dim AtualizarLista As Action = Sub()
    Dim prefixo = txtPrefixo.Text.Trim().ToLower()
    lstModelos.Items.Clear()
    For Each kvp In compDocs
        Dim nomeArq = System.IO.Path.GetFileNameWithoutExtension(kvp.Key).ToLower()
        If nomeArq.StartsWith(prefixo) Then lstModelos.Items.Add(kvp.Key)
    Next
End Sub

AddHandler btnFiltrar.Click, Sub()
    AtualizarLista()
    If lstModelos.Items.Count = 0 Then
        MessageBox.Show("Nenhum modelo encontrado com o prefixo '" & txtPrefixo.Text.Trim() & "'.", "Aviso")
    End If
End Sub

AddHandler btnSelecionarTodos.Click, Sub()
    For i = 0 To lstModelos.Items.Count - 1
        lstModelos.SetItemChecked(i, True)
    Next
End Sub

AddHandler btnDesmarcarTodos.Click, Sub()
    For i = 0 To lstModelos.Items.Count - 1
        lstModelos.SetItemChecked(i, False)
    Next
End Sub

AddHandler btnOk.Click, Sub()
    If lstModelos.CheckedItems.Count = 0 Then
        MessageBox.Show("Selecione ao menos um modelo.", "Aviso")
        Return
    End If
    frmSelecao.DialogResult = DialogResult.OK
    frmSelecao.Close()
End Sub

' === Executa seleção ===
AtualizarLista()
If frmSelecao.ShowDialog() <> DialogResult.OK Then Return

Dim modelosSelecionados As New List(Of Document)
For Each item As String In lstModelos.CheckedItems
    modelosSelecionados.Add(compDocs(item))
Next

' === Lista de acabamentos ===
Dim acabamentos() As String = {
    "Escovado", "Treme-treme", "Polido", "Usinado", "Decapado", "Pintado",
    "Natural", "Galv. Frio", "Natural / Decapado", "Natural / Usinado", "N/A"
}

' === Loop pelos documentos ===
For Each oDoc As Document In modelosSelecionados
    Try
        If oDoc.IsContentCenterFile OrElse Not oDoc.IsModifiable Then
            MessageBox.Show("Arquivo não editável ou do Content Center: " & oDoc.DisplayName, "Aviso")
            Continue For
        End If

        ' Abre documento com permissão de edição
        ThisApplication.Documents.Open(oDoc.FullFileName, False).Activate()

        ' Propriedades
        Dim docSummaryProps As PropertySet = oDoc.PropertySets.Item("Inventor Document Summary Information")

        ' === Formulário do acabamento ===
        Dim frmAcabamento As New System.Windows.Forms.Form With {
            .Text = "Acabamento - " & oDoc.DisplayName,
            .Width = 500,
            .Height = 200,
            .StartPosition = FormStartPosition.CenterScreen
        }

        frmAcabamento.Controls.Add(New System.Windows.Forms.Label With {.Text = "Acabamento:", .Top = 20, .Left = 20, .Width = 100})

        Dim cboAcabamento As New System.Windows.Forms.ComboBox With {
            .Top = 50, .Left = 20, .Width = 440, .DropDownStyle = ComboBoxStyle.DropDownList
        }
        cboAcabamento.Items.AddRange(acabamentos)
        cboAcabamento.SelectedIndex = 0
        frmAcabamento.Controls.Add(cboAcabamento)

        Dim btnAplicar As New System.Windows.Forms.Button With {
            .Text = "Aplicar", .Top = 100, .Left = 20, .Width = 440
        }

        AddHandler btnAplicar.Click, Sub()
            Try
                Dim acabamentoProp As Inventor.Property
                Try
                    acabamentoProp = docSummaryProps.Item("Keywords")
                Catch
                    acabamentoProp = docSummaryProps.Add("", "Keywords")
                End Try

                acabamentoProp.Value = cboAcabamento.Text
                oDoc.Save()
                MessageBox.Show("Acabamento aplicado com sucesso em: " & oDoc.DisplayName, "Sucesso")
                frmAcabamento.Close()
            Catch ex As Exception
                MessageBox.Show("Erro ao aplicar acabamento em: " & oDoc.DisplayName & vbCrLf & ex.Message, "Erro")
            End Try
        End Sub

        frmAcabamento.Controls.Add(btnAplicar)
        frmAcabamento.ShowDialog()

        oDoc.Close(True)

    Catch ex As Exception
        MessageBox.Show("Erro ao processar '" & oDoc.DisplayName & "':" & vbCrLf & ex.Message, "Erro Geral")
    End Try
Next
